# Aion Save System

**Aion Save System** is a modular and deterministic save/load framework for **Unity 6.2+**.
It provides robust, efficient, and flexible game state persistence using clean JSON serialization, optional compression/encryption, autosaving, compile-time snapshot generation, and strong data integrity verification.

**Namespace:** `BPG.Aion`
**UPM Package:** `com.bpg.aion`

---

## ‚ú® Key Features

* Deterministic JSON serialization with stable field ordering.
* Atomic file writes and built-in checksum validation.
* Optional **GZip compression** and **AES-GCM encryption**.
* Multi-profile and multi-slot save system.
* Autosave controller with rolling backups.
* Streaming I/O for large saves (progress and cancellation support).
* Lightweight diagnostics via `SaveProfiler` (timing, memory, compression ratio).
* **Compile-time snapshot generation** to eliminate runtime reflection overhead.
* Extensible architecture with interfaces for custom serializers, storage, and encryption.
* Editor integration for easy debugging, code generation, and testing.

---

## ‚öôÔ∏è Installation

### Install via Git URL (Recommended)

1. Open **Unity Editor**.
2. Go to **Window ‚Üí Package Manager**.
3. Click **+ ‚Üí Add package from Git URL...**
4. Paste the following URL and press Enter:

   ```
   https://github.com/Blank-Page-Games-Studio/Aion-Save-System.git#v0.7.9
   ```

### Add to `manifest.json`

```json
"com.bpg.aion": "https://github.com/Blank-Page-Games-Studio/Aion-Save-System.git#v0.7.9"
```

### Manual Install (Offline)

1. Download or copy the folder `Packages/com.bpg.aion/` into your project.
2. In Unity: **Package Manager ‚Üí Add package from disk‚Ä¶** and select `package.json`.

---

## üöÄ Quick Start

### 1. Create a Saveable Component

```csharp
using BPG.Aion;
using UnityEngine;

[GenerateSaveSnapshot] // Optional for compile-time snapshot optimization
[SaveKey("PlayerStats")]
public sealed partial class PlayerStats : MonoBehaviour, ISaveable
{
    [SaveField] public int level;
    [SaveField] public float health;
    [SaveField] public Vector3 position;

    public string? SaveKeyOverride => "PlayerStats:Main";
    public Component AsComponent => this;

    public void OnBeforeSave() { Debug.Log("Preparing save"); }
    public void OnAfterLoad() { Debug.Log("Data loaded"); }
}
```

> The `[GenerateSaveSnapshot]` attribute lets Unity generate strongly-typed code that captures and restores data without reflection, improving runtime performance.

### 2. Save and Load Example

```csharp
var manager = new SaveManager(new JsonSerializer(), new FileSystemStorage());
manager.Register(playerStats);

await manager.SaveAsync(1, new SaveOptions { ProfileName = "Default" });
await manager.LoadAsync(1, new LoadOptions { ProfileName = "Default" });
```

### 3. Use the Sample Prefab

A simple prefab is available under `Samples~/SimpleThreeSlot`. It includes:

* 3 save slots with Save, Load, and Delete buttons.
* Progress feedback and status display.
* Integrated autosave controller and diagnostics overlay.

---

## üß© Snapshot Generation

Aion can automatically generate fast, strongly-typed snapshot code at **edit time** for any component that uses `[GenerateSaveSnapshot]`. This feature replaces runtime reflection with precompiled accessors.

### How It Works

* Mark your class as `partial` and add `[GenerateSaveSnapshot]`.
* The Unity Editor scans for these classes and writes generated files under:

  ```
  Assets/Aion.Generated/{TypeName}_Generated.cs
  ```
* Generated snapshots include a nested struct (e.g., `Snapshot`) and two methods:

  ```csharp
  object CaptureSnapshot();
  void RestoreSnapshot(object snapshot);
  ```
* Aion automatically detects these methods at runtime and uses them instead of reflection.

### Example Generated Output

```csharp
// <auto-generated by Aion Save System>
#nullable enable
using System;
using UnityEngine;
namespace BPG.Aion.Samples {
partial class PlayerStats {
    [Serializable]
    public struct Snapshot {
        public int level;
        public float health;
        public Vector3 position;
    }

    public object CaptureSnapshot() {
        return new Snapshot { level = this.level, health = this.health, position = this.position };
    }

    public void RestoreSnapshot(object snapshot) {
        if (snapshot is Snapshot dto) {
            this.level = dto.level;
            this.health = dto.health;
            this.position = dto.position;
        }
    }
}
}
```

### Editor Window

Open **Window ‚Üí BPG Aion ‚Üí Snapshot Generator** to:

* Generate or refresh all snapshot files.
* Inspect all `[GenerateSaveSnapshot]` components.
* Quickly open the generated folder.

This runs entirely in the Editor, producing deterministic source files tracked by version control.

---

## üß¨ Architecture Overview

| Component                 | Role                                                                                             |
| ------------------------- | ------------------------------------------------------------------------------------------------ |
| **`SaveManager`**         | Coordinates all save/load operations and manages the pipeline.                                   |
| **`ISaveable`**           | Interface implemented by any saveable component. Fields marked with `[SaveField]` are persisted. |
| **`ISerializer`**         | Handles serialization logic (JSON by default). Custom serializers can be injected.               |
| **`IStorageProvider`**    | Manages low-level file operations, atomic writes, and backups.                                   |
| **`ICompressor`**         | Optional interface for data compression. Default: `GZipCompressor`.                              |
| **`IEncryptor`**          | Optional interface for encryption. Default: `AesGcmEncryptor`.                                   |
| **`AutosaveController`**  | Periodically triggers saves or responds to scene changes.                                        |
| **`SaveProfiler`**        | Measures duration, memory allocation, and I/O stats per operation.                               |
| **`Generated Snapshots`** | Compile-time generated classes that capture/restore data instantly, without reflection.          |

---

## üß† Data Flow Summary

1. **Capture:** Each registered `ISaveable` provides its state, either via reflection or generated snapshot code.
2. **Serialize:** All data is serialized into JSON.
3. **Transform:** (Optional) Compress ‚Üí (Optional) Encrypt ‚Üí Compute checksum.
4. **Write:** Save atomically to disk with a JSON header + body.
5. **Load:** Reverse process (read, verify, decrypt, decompress, restore).

This process ensures consistent, verifiable, and high-performance saves with minimal overhead.

---

## üß™ Testing

Run **Unity Test Runner ‚Üí EditMode Tests** to validate system integrity. Tests cover:

* Round-trip save/load correctness.
* Header checksum and corruption detection.
* Compression and encryption validation.
* Autosave rotation and recovery.
* Snapshot generation and reflection fallback.
* Performance and memory profiling.

---

## ‚ùì FAQ

**Q: What does snapshot generation do?**
It automatically generates optimized C# code to serialize `[SaveField]` members without reflection, improving runtime performance.

**Q: Do I need to use `[GenerateSaveSnapshot]`?**
No. It‚Äôs optional ‚Äî Aion falls back to reflection if no generated snapshot is present.

**Q: Where are save files stored?**
`Application.persistentDataPath/BPG.Saves/{ProfileName}/slot_{N}.bpgsave`

**Q: Can I use my own serialization format?**
Yes. Implement `ISerializer` and inject it into `SaveManager`.

**Q: How does it handle file corruption?**
Every save includes a checksum verified on load. Corrupted files will not overwrite valid data.

**Q: Can it autosave automatically?**
Yes. Add `AutosaveController` to your scene and configure interval and backup count.

---

## üß± Roadmap

* ‚úÖ Deterministic JSON serialization and reflection-based saves
* ‚úÖ Compression and encryption support
* ‚úÖ Multi-slot profiles with autosave
* ‚úÖ Streaming I/O with progress tracking
* ‚úÖ Editor-integrated compile-time snapshot generation
* ‚ñ∂ Cloud save, ECS/DOTS support, and remote storage (planned)

---

## üìú License

Licensed under the **Apache License 2.0**. See `LICENSE` for details.
